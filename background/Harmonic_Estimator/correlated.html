<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>&lt;no title&gt; &mdash; Harmonic 1.0.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom_tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/dark_mode_css/general.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/dark_mode_css/dark.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script src="../../_static/dark_mode_js/default_light.js"></script>
        <script src="../../_static/dark_mode_js/theme_switcher.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html">
            <img src="../../_static/harm_badge_simple.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user_guide/install.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Mathematics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html">Harmonic Mean Estimator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Machine_Learning/index.html">Learnt Container Function</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Jupyter Notebooks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../examples/index.html">Benchmark Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">Namespaces</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Changelog</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/changes.html">GitHub History</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Harmonic</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>&lt;no title&gt;</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/background/Harmonic_Estimator/correlated.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<p>We present an estimator of the reciprocal marginal likelihood, an estimate of the variance of this estimator, and its variance. These estimators make use of correlated samples in order to avoid the loss of efficiency that results from thinning an MCMC chain.</p>
<p>We propose running a number of independent MCMC chains and using all of the correlated samples within a given chain. A number of modern MCMC sampling techniques, such as affine invariance ensemble samplers naturally provide samples from multiple chains by their ensemble nature. Moreoever, excellent software implementations are readily available, such as the <a class="reference external" href="https://emcee.readthedocs.io/en/stable/">emcee</a> code, which provides an implementation of the affine invariance ensember samplers proposed by <a class="reference external" href="https://msp.org/camcos/2010/5-1/camcos-v5-n1-p04-s.pdf">Goodman (2010)</a>. Alternatively, if only a single large chain is available then this can be broken into separate blocks, which are (approximately) indpendent for a suitably long block length. Subsequently, we use the terminology chains throughout to refer to both scenarios of running multiple MCMC chains or separating a single chain in blocks.</p>
<p>Consider <span class="math notranslate nohighlight">\(C\)</span> chains of samples, indexed by <span class="math notranslate nohighlight">\(j = 1, 2, \ldots, C\)</span>, with chain <span class="math notranslate nohighlight">\(j\)</span> containing <span class="math notranslate nohighlight">\(N_j\)</span> samples.  The <span class="math notranslate nohighlight">\(i^{\text{th}}\)</span> sample of chain <span class="math notranslate nohighlight">\(j\)</span> is denoted <span class="math notranslate nohighlight">\(\theta_{ij}\)</span>.  Since the chain of interest is typically clear from the context, for notational brevity we drop the chain index from the samples, <em>i.e.</em> we denotate samples by <span class="math notranslate nohighlight">\(\theta_i\)</span> where the chain of interest is inferred from the context.</p>
<p>An estimator of the reciprocal marginal likelihood can be computed from each independent chain by</p>
<div class="math notranslate nohighlight">
\[\hat{\rho}_j = \frac{1}{N_j} \sum_{i=1}^{N_j} \frac{\varphi(\theta_i)}{\mathcal{L}(\theta_i) \pi(\theta_i)}, \quad \theta_i \sim \text{P}(\theta | y).\]</div>
<p>A single estimator of the reciprocal marginal likelihood can then be constructed from the estimator for each chain by</p>
<div class="math notranslate nohighlight">
\[\hat{\rho} = \frac{\sum_{j=1}^{C} w_j \hat{\rho}_j} {\sum_{j=1}^{C} w_j },\]</div>
<p>where the estimator <span class="math notranslate nohighlight">\(\hat{\rho}_j\)</span> of chain <span class="math notranslate nohighlight">\(j\)</span> is weighted by the number of samples in the chain, <em>i.e.</em> <span class="math notranslate nohighlight">\(w_j = N_j\)</span>.  It is straightforward to see that the estimator of the reciprocal marginal likelihood is unbiased, <em>i.e.</em> <span class="math notranslate nohighlight">\(\mathbb{E}(\hat{\rho})= \rho\)</span>, since <span class="math notranslate nohighlight">\(\mathbb{E}(\hat{\rho}_j) = \rho\)</span>.</p>
<p>The variance of the estimator <span class="math notranslate nohighlight">\(\hat{\rho}\)</span> is related to the population variance <span class="math notranslate nohighlight">\(\sigma^2 = \mathbb{E}\bigl[ (\hat{\rho}_i - \mathbb{E}(\hat{\rho}_i))^2 \bigr]\)</span> by</p>
<div class="math notranslate nohighlight">
\[\text{var}(\hat{\rho}) = \frac{\sigma^2}{N_\text{eff}},\]</div>
<p>where the effective sample size is given by</p>
<div class="math notranslate nohighlight">
\[N_\text{eff} = \frac{\bigl(\sum_j^{C} w_j \bigr)^2}{\sum_j^{C} w_j^2}.\]</div>
<p>The estimator of the population variance, given by</p>
<div class="math notranslate nohighlight">
\[\hat{s}^2 = \frac{N_\text{eff}} {N_\text{eff}-1} \frac{\sum_{j=1}^{C} w_j (\hat{\rho}_j-\hat{\rho})^2}{\sum_j^{C} w_j},\]</div>
<p>is unbiased, <em>i.e.</em> <span class="math notranslate nohighlight">\(\mathbb{E}(\hat{s}^2) = \sigma^2\)</span>. A suitable estimator for <span class="math notranslate nohighlight">\(\text{var}(\hat{\rho})\)</span> is thus</p>
<div class="math notranslate nohighlight">
\[\hat{\sigma}^2 = \frac{\hat{s}^2}{N_\text{eff}} = \frac{1} {N_\text{eff}-1} \frac{\sum_{j=1}^{C} w_j (\hat{\rho}_j-\hat{\rho})^2}{\sum_j^{C} w_j},\]</div>
<p>which is unbiased, <em>i.e.</em> <span class="math notranslate nohighlight">\(\mathbb{E}(\hat{\sigma}^2) = \text{var}(\hat{\rho})\)</span>, since <span class="math notranslate nohighlight">\(\hat{s}^2\)</span> is unbiased. The variance of the estimator <span class="math notranslate nohighlight">\(\hat{\sigma}^2\)</span> reads</p>
<div class="math notranslate nohighlight">
\[\text{var}(\hat{\sigma}^2) = \frac{1}{N_\text{eff}{}^2} \text{var}(\hat{s}^2) = \frac{\sigma^4}{N_\text{eff}{}^3} \biggl(\kappa - 1 + \frac{2}{N_\text{eff}-1}\biggr),\]</div>
<p>where in the second equality we have used a well-known result for the variance of the sample variance of independent and identically distributed (i.i.d.) random variables.
The kurtosis <span class="math notranslate nohighlight">\(\kappa\)</span> is defined by</p>
<div class="math notranslate nohighlight">
\[\kappa = \text{kur}(\hat{\rho}_i) = \mathbb{E} \Biggl[ \biggl(\frac{\hat{\rho}_i - \rho}{\sigma}\biggr)^4 \Biggr].\]</div>
<p>A suitable estimator for <span class="math notranslate nohighlight">\(\text{var}(\hat{\sigma}^2)\)</span> is thus</p>
<div class="math notranslate nohighlight">
\[\hat{\nu}^4 = \frac{\hat{s}^4}{N_\text{eff}{}^3} \biggl(\hat{\kappa} - 1 + \frac{2}{N_\text{eff}-1}\biggr) = \frac{\hat{\sigma}^4}{N_\text{eff}{}} \biggl(\hat{\kappa} - 1 + \frac{2}{N_\text{eff}-1}\biggr),\]</div>
<p>where for the kurtosis we adopt the estimator</p>
<div class="math notranslate nohighlight">
\[\begin{split}\hat{\kappa} = \frac{\sum_{j=1}^{C} w_j (\hat{\rho}_j-\hat{\rho})^4} {\hat{s}^4 \sum_{j=1}^{C} w_j} \\ = \frac{\sum_{j=1}^{C} w_j (\hat{\rho}_j-\hat{\rho})^4} {N_\text{eff}{}^2 \hat{\sigma}^4 \sum_{j=1}^{C} w_j}.\end{split}\]</div>
<p>The estimators <span class="math notranslate nohighlight">\(\hat{\rho}\)</span>, <span class="math notranslate nohighlight">\(\hat{\sigma}^2\)</span> and <span class="math notranslate nohighlight">\(\hat{\nu}^4\)</span> provide a strategy to esimate the reciprocal marginal likelihood, its variance, and the variance of the variance, respectively. The variance estimators provide valuable measures of the accuracy of the estimated reciprocal marginal likelihood and provide useful sanity checks. Additional sanity checks can also be considered.</p>
<p>By the central limit theorem, for a large number of samples the distribution of <span class="math notranslate nohighlight">\(\hat{\rho}_j\)</span> approaches a Gaussian, with kurtosis <span class="math notranslate nohighlight">\(\kappa=3\)</span>.  If the estimated kurtosis <span class="math notranslate nohighlight">\(\hat{\kappa} \gg 3\)</span> it would indicate that the sampled distribution of <span class="math notranslate nohighlight">\(\hat{\rho}_j\)</span> has long tails, suggesting further samples need to be drawn.</p>
<p>Similarly, the ratio of <span class="math notranslate nohighlight">\(\hat{\nu}^2 / \hat{\sigma}^2\)</span> can be inspected to see if it is close to that expected for a Gaussian distribution with <span class="math notranslate nohighlight">\(\kappa=3\)</span> of</p>
<div class="math notranslate nohighlight">
\[\frac{\hat{\nu}^4}{\hat{\sigma}^4} = \frac{1}{N_\text{eff}{}} \biggl(2 + \frac{2}{N_\text{eff}-1}\biggr) = \frac{2}{N_\text{eff}-1}\]</div>
<p>or equivalently</p>
<div class="math notranslate nohighlight">
\[\frac{\hat{\nu}^2}{\hat{\sigma}^2} = \sqrt{\frac{2}{N_\text{eff}-1}}.\]</div>
<p>For the common setting where the number of samples per chain is constant, <em>i.e.</em> <span class="math notranslate nohighlight">\(N_j = N\)</span> for all <span class="math notranslate nohighlight">\(j\)</span>,</p>
<div class="math notranslate nohighlight">
\[N_\text{eff} = \frac{\bigl(\sum_j^{C} w_j \bigr)^2}{\sum_j^{C} w_j^2} = \frac{(N C)^2}{N^2 C} = C\]</div>
<p>and, say <span class="math notranslate nohighlight">\(C=100\)</span>, we find <span class="math notranslate nohighlight">\(\hat{\nu}^2 / \hat{\sigma}^2 = 0.14\)</span>. In this setting significantly larger values of this ratio would suggest that further samples need to be drawn.</p>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Jason D. McEwen, Christopher G. R. Wallis, Matthew A. Price, Matthew M. Docherty.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>